name: VM Bootstrap (one-time)

on:
  workflow_dispatch:
    inputs:
      setup_nginx:
        description: 'Configure Nginx reverse proxy on the VM'
        required: false
        default: 'false'
      enable_ssl:
        description: 'If setup_nginx=true, request/renew Let''s Encrypt cert'
        required: false
        default: 'false'

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Prepare deploy directories on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT }}
          script: |
            set -euo pipefail
            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"

            if ! sudo -n true 2>/dev/null; then
              echo "ERROR: This requires non-interactive sudo on the VM." >&2
              echo "Fix: grant NOPASSWD sudo to '${{ secrets.DEPLOY_USER }}' (recommended), or set DEPLOY_USER=root." >&2
              exit 1
            fi

            sudo -n mkdir -p "$DEPLOY_PATH" "$DEPLOY_PATH/.deploy"
            sudo -n chown "${USER}:${USER}" "$DEPLOY_PATH" "$DEPLOY_PATH/.deploy"

      - name: Upload VM scripts to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT }}
          source: "scripts/vm_bootstrap.sh,scripts/vm_nginx_setup.sh"
          target: ${{ secrets.DEPLOY_PATH }}/.deploy

      - name: Run bootstrap (and optional Nginx)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT }}
          script: |
            set -euo pipefail

            DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
            DEPLOY_USER="${{ secrets.DEPLOY_USER }}"

            sudo -n true

            chmod +x "$DEPLOY_PATH/.deploy/scripts/vm_bootstrap.sh" "$DEPLOY_PATH/.deploy/scripts/vm_nginx_setup.sh"

            sudo -n bash "$DEPLOY_PATH/.deploy/scripts/vm_bootstrap.sh" --deploy-path "$DEPLOY_PATH" --user "$DEPLOY_USER"

            if [[ "${{ inputs.setup_nginx }}" == "true" ]]; then
              DOMAIN='${{ secrets.DEPLOY_DOMAIN }}'
              if [[ -z "$DOMAIN" ]]; then
                echo "ERROR: DEPLOY_DOMAIN secret is required when setup_nginx=true" >&2
                exit 1
              fi

              sudo -n bash "$DEPLOY_PATH/.deploy/scripts/vm_nginx_setup.sh" \
                --domain "$DOMAIN" \
                --frontend-port 3000 \
                --backend-port 8000 \
                --enable-ssl "${{ inputs.enable_ssl }}" \
                --email "${{ secrets.LETSENCRYPT_EMAIL }}"
            fi

            echo "Bootstrap done."
