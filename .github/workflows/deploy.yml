name: Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      frontend_image: ${{ steps.meta-frontend.outputs.tags }}
      backend_image: ${{ steps.meta-backend.outputs.tags }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    # Set up metadata for frontend
    - name: Extract frontend metadata
      id: meta-frontend
      uses: docker/metadata-action@v4
      with:
        images: ghcr.io/${{ github.repository_owner }}/postbot-frontend
        tags: |
          type=raw,value=latest
          type=sha,prefix={{branch}}-

    # Build and push frontend image with cache
    - name: Build and push frontend image
      uses: docker/build-push-action@v4
      with:
        context: .
        file: ./Dockerfile.frontend
        push: true
        tags: ${{ steps.meta-frontend.outputs.tags }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          VITE_SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_KEY }}
          VITE_API_URL=${{ secrets.API_URL }}
          VITE_REDIRECT_URL=${{ secrets.REDIRECT_URL }}
          VITE_ENV=production

    # Set up metadata for backend
    - name: Extract backend metadata
      id: meta-backend
      uses: docker/metadata-action@v4
      with:
        images: ghcr.io/${{ github.repository_owner }}/postbot-backend
        tags: |
          type=raw,value=latest
          type=sha,prefix={{branch}}-

    # Build and push backend image with cache
    - name: Build and push backend image
      uses: docker/build-push-action@v4
      with:
        context: .
        file: ./Dockerfile.backend
        push: true
        tags: ${{ steps.meta-backend.outputs.tags }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          REDDIT_CLIENT_ID=${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET=${{ secrets.REDDIT_CLIENT_SECRET }}
          REDDIT_USER_AGENT=${{ secrets.REDDIT_USER_AGENT }}
          SERPER_API_KEY=${{ secrets.SERPER_API_KEY }}
          SUPABASE_POSTGRES_DSN=${{ secrets.SUPABASE_POSTGRES_DSN }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: production

    steps:
    # Initial EC2 Setup
    - name: Initial EC2 Setup
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script_stop: true
        command_timeout: "30m"
        script: |
          sudo mkdir -p /home/ubuntu/postbot
          sudo chown ubuntu:ubuntu /home/ubuntu/postbot
          # Create docker group if it doesn't exist
          sudo groupadd -f docker
          sudo usermod -aG docker ubuntu
          # Apply group changes
          newgrp docker

    # Copy deployment files
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Copy deployment files
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "deploy.sh,ec2-docker-compose.yml"
        target: "/home/ubuntu/postbot"
        strip_components: 0

    # Deploy to EC2
    - name: Deploy to EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script_stop: true
        command_timeout: "30m"
        envs: |
          GITHUB_TOKEN
          GITHUB_USERNAME
          API_URL
          REDIRECT_URL
          SUPABASE_URL
          SUPABASE_KEY
          GEMINI_API_KEY
          REDDIT_CLIENT_ID
          REDDIT_CLIENT_SECRET
          REDDIT_USER_AGENT
          SERPER_API_KEY
          SUPABASE_POSTGRES_DSN
        script: |
          cd /home/ubuntu/postbot
          
          # Create or update environment file
          cat > .env << EOL
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
          REDDIT_CLIENT_ID=${{ secrets.REDDIT_CLIENT_ID }}
          REDDIT_CLIENT_SECRET=${{ secrets.REDDIT_CLIENT_SECRET }}
          REDDIT_USER_AGENT=${{ secrets.REDDIT_USER_AGENT }}
          SERPER_API_KEY=${{ secrets.SERPER_API_KEY }}
          SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}
          SUPABASE_POSTGRES_DSN=${{ secrets.SUPABASE_POSTGRES_DSN }}
          API_URL=${{ secrets.API_URL }}
          REDIRECT_URL=${{ secrets.REDIRECT_URL }}
          VITE_SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_KEY }}
          VITE_API_URL=${{ secrets.API_URL }}/api
          VITE_REDIRECT_URL=${{ secrets.REDIRECT_URL }}
          EOL
          
          # Export variables for the deploy script
          export GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}"
          export GITHUB_USERNAME="${{ github.actor }}"
          export SUPABASE_URL="${{ secrets.SUPABASE_URL }}"
          export SUPABASE_KEY="${{ secrets.SUPABASE_KEY }}"
          export GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}"
          export REDDIT_CLIENT_ID="${{ secrets.REDDIT_CLIENT_ID }}"
          export REDDIT_CLIENT_SECRET="${{ secrets.REDDIT_CLIENT_SECRET }}"
          export REDDIT_USER_AGENT="${{ secrets.REDDIT_USER_AGENT }}"
          export SERPER_API_KEY="${{ secrets.SERPER_API_KEY }}"
          export API_URL="${{ secrets.API_URL }}"
          export REDIRECT_URL="${{ secrets.REDIRECT_URL }}"
          export SUPABASE_POSTGRES_DSN="${{ secrets.SUPABASE_POSTGRES_DSN }}"
          
          # Make deploy script executable
          sudo chmod +x deploy.sh
          
          # Run deploy script with sudo and environment variables
          sudo -E ./deploy.sh
          
          # Ensure proper ownership after deployment
          sudo chown -R ubuntu:ubuntu /home/ubuntu/postbot
          sudo chown -R ubuntu:ubuntu /home/ubuntu/.docker
          
          # Verify docker access
          docker ps