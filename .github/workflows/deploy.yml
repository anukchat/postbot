name: Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push frontend image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile.frontend
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/postbot-frontend:latest
          build-args: |
            VITE_SUPABASE_URL=${{ secrets.SUPABASE_URL }}
            VITE_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_KEY }}
            VITE_API_URL=${{ secrets.API_URL }}
            VITE_REDIRECT_URL=${{ secrets.REDIRECT_URL }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push backend image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile.backend
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/postbot-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Check if EC2 is reachable
        run: |
          echo "Checking if ${{ secrets.EC2_HOST }} is reachable on port 22..."
          timeout 10 nc -zv ${{ secrets.EC2_HOST }} 22 || echo "Cannot connect to EC2 instance on port 22"

      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_USERNAME: ${{ github.repository_owner }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          command_timeout: "30m"
          envs: GITHUB_TOKEN,GITHUB_USERNAME
          script: |
            echo "Starting deployment process at $(date)"
            cd /home/ubuntu/postbot
            
            # Create fresh .env file
            echo "Creating .env file with secrets..."
            cat > .env << EOL
            SUPABASE_URL=${{ secrets.SUPABASE_URL }}
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            REDDIT_CLIENT_ID=${{ secrets.REDDIT_CLIENT_ID }}
            REDDIT_CLIENT_SECRET=${{ secrets.REDDIT_CLIENT_SECRET }}
            REDDIT_USER_AGENT=${{ secrets.REDDIT_USER_AGENT }}
            SERPER_API_KEY=${{ secrets.SERPER_API_KEY }}
            SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}
            SUPABASE_POSTGRES_DSN=${{ secrets.SUPABASE_POSTGRES_DSN }}
            API_URL=${{ secrets.API_URL }}
            REDIRECT_URL=${{ secrets.REDIRECT_URL }}
            VITE_SUPABASE_URL=${{ secrets.SUPABASE_URL }}
            VITE_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_KEY }}
            VITE_API_URL=${{ secrets.API_URL }}
            VITE_REDIRECT_URL=${{ secrets.REDIRECT_URL }}
            EOL
            
            # Set proper permissions for .env
            chmod 600 .env
            
            # Export GitHub auth variables
            export GITHUB_TOKEN="${GITHUB_TOKEN}"
            export GITHUB_USERNAME="${GITHUB_USERNAME}"

            # Login to GitHub Container Registry
            echo "Logging in to GitHub Container Registry..."
            echo "${GITHUB_TOKEN}" | docker login ghcr.io -u ${GITHUB_USERNAME} --password-stdin
            
            echo "Running deployment script..."
            # Run the deployment script
            /home/ubuntu/deploy.sh
            
            # Verify containers are running after deployment
            echo "Verifying deployment:"
            docker ps
            
            # Check Nginx is running
            echo "Checking Nginx status:"
            systemctl status nginx
