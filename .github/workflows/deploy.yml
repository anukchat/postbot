name: Build and Deploy to Kubernetes

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push frontend image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile.frontend
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/postbot-frontend:latest
            ghcr.io/${{ github.repository_owner }}/postbot-frontend:${{ github.sha }}
          build-args: |
            VITE_SUPABASE_URL=${{ secrets.SUPABASE_URL }}
            VITE_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_KEY }}
            VITE_AUTH_PROVIDER_URL=${{ secrets.AUTH_PROVIDER_URL }}
            VITE_AUTH_PROVIDER_KEY=${{ secrets.AUTH_PROVIDER_KEY }}
            VITE_API_URL=${{ secrets.API_URL }}
            VITE_REDIRECT_URL=${{ secrets.REDIRECT_URL }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push backend image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile.backend
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/postbot-backend:latest
            ghcr.io/${{ github.repository_owner }}/postbot-backend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-kubernetes:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure Kubernetes context
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Verify cluster connection
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Create or update secrets
        run: |
          kubectl create namespace postbot --dry-run=client -o yaml | kubectl apply -f -
          
          kubectl create secret generic postbot-secrets \
            --from-literal=DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            --from-literal=AUTH_PROVIDER_URL="${{ secrets.AUTH_PROVIDER_URL }}" \
            --from-literal=AUTH_PROVIDER_KEY="${{ secrets.AUTH_PROVIDER_KEY }}" \
            --from-literal=FRONTEND_URL="${{ secrets.FRONTEND_URL }}" \
            --from-literal=GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}" \
            --from-literal=GROQ_API_KEY="${{ secrets.GROQ_API_KEY }}" \
            --from-literal=REDDIT_CLIENT_ID="${{ secrets.REDDIT_CLIENT_ID }}" \
            --from-literal=REDDIT_CLIENT_SECRET="${{ secrets.REDDIT_CLIENT_SECRET }}" \
            --from-literal=REDDIT_USER_AGENT="${{ secrets.REDDIT_USER_AGENT }}" \
            --from-literal=SERPER_API_KEY="${{ secrets.SERPER_API_KEY }}" \
            --from-literal=API_URL="${{ secrets.API_URL }}" \
            --from-literal=REDIRECT_URL="${{ secrets.REDIRECT_URL }}" \
            --namespace=postbot \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy to Kubernetes
        run: |
          kubectl apply -k k8s/overlays/production
          
      - name: Force rollout restart
        run: |
          kubectl rollout restart deployment/backend -n postbot
          kubectl rollout restart deployment/frontend -n postbot

      - name: Wait for rollout to complete
        run: |
          kubectl rollout status deployment/backend -n postbot --timeout=5m
          kubectl rollout status deployment/frontend -n postbot --timeout=5m

      - name: Verify deployment
        run: |
          echo "=== Pods Status ==="
          kubectl get pods -n postbot
          echo ""
          echo "=== Services ==="
          kubectl get services -n postbot
          echo ""
          echo "=== Ingress ==="
          kubectl get ingress -n postbot
          echo ""
          echo "âœ… Deployment completed successfully!"
