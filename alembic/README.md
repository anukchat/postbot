# Alembic Database Migrations

This directory contains Alembic migrations for the PostBot database schema.

## Quick Start

### Initialize Alembic (Already Done)
```bash
# Already initialized - alembic.ini and alembic/ directory exist
```

### Create a New Migration

**Auto-generate migration from model changes:**
```bash
alembic revision --autogenerate -m "Add new column to profiles"
```

**Create empty migration (for manual SQL):**
```bash
alembic revision -m "Manual migration description"
```

### Apply Migrations

**Upgrade to latest:**
```bash
alembic upgrade head
```

**Upgrade one version:**
```bash
alembic upgrade +1
```

**Downgrade one version:**
```bash
alembic downgrade -1
```

### Check Current Version
```bash
alembic current
```

### View Migration History
```bash
alembic history --verbose
```

## Directory Structure

```
alembic/
├── versions/          # Migration files stored here
│   └── xxxx_initial_schema.py
├── env.py            # Migration environment configuration
└── script.py.mako    # Migration file template
```

## Configuration

Alembic reads database connection from:
1. **DATABASE_URL** environment variable (priority)
2. Individual env vars: DB_USER, DB_PASSWORD, DB_HOST, DB_PORT, DB_NAME
3. alembic.ini fallback configuration

### Environment Variables

```bash
# Option 1: Full connection string
export DATABASE_URL="postgresql://user:pass@localhost:5432/postbot_dev"

# Option 2: Individual variables
export DB_USER="postgres"
export DB_PASSWORD="yourpassword"
export DB_HOST="localhost"
export DB_PORT="5432"
export DB_NAME="postbot_dev"
```

## Best Practices

### 1. Always Review Auto-Generated Migrations
```bash
# After creating autogenerated migration, review the file
alembic revision --autogenerate -m "description"
# Then edit: alembic/versions/xxxx_description.py
```

### 2. Test Migrations Locally First
```bash
# Apply migration
alembic upgrade head

# Test rollback
alembic downgrade -1

# Re-apply
alembic upgrade head
```

### 3. Never Edit Applied Migrations
- Once deployed to production, never modify existing migration files
- Create new migrations for changes

### 4. Add Data Migrations When Needed
```python
def upgrade():
    # Schema change
    op.add_column('profiles', sa.Column('new_field', sa.String()))
    
    # Data migration
    connection = op.get_bind()
    connection.execute("UPDATE profiles SET new_field = 'default' WHERE new_field IS NULL")
```

### 5. Handle Backwards Compatibility
```python
def downgrade():
    # Reverse data migration first (if needed)
    # Then reverse schema change
    op.drop_column('profiles', 'new_field')
```

## Common Operations

### Add Column
```python
def upgrade():
    op.add_column('table_name', 
        sa.Column('new_column', sa.String(255), nullable=True))

def downgrade():
    op.drop_column('table_name', 'new_column')
```

### Rename Column
```python
def upgrade():
    op.alter_column('table_name', 'old_name', new_column_name='new_name')

def downgrade():
    op.alter_column('table_name', 'new_name', new_column_name='old_name')
```

### Create Index
```python
def upgrade():
    op.create_index('idx_profiles_email', 'profiles', ['email'])

def downgrade():
    op.drop_index('idx_profiles_email')
```

### Add Foreign Key
```python
def upgrade():
    op.create_foreign_key(
        'fk_content_profile',
        'content', 'profiles',
        ['profile_id'], ['id'],
        ondelete='CASCADE'
    )

def downgrade():
    op.drop_constraint('fk_content_profile', 'content', type_='foreignkey')
```

## Deployment

### Development
```bash
# Apply migrations
alembic upgrade head
```

### Production (CI/CD)
```yaml
# In your deployment pipeline
- name: Run Database Migrations
  run: |
    alembic upgrade head
  env:
    DATABASE_URL: ${{ secrets.DATABASE_URL }}
```

### Kubernetes Job
```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: db-migration
spec:
  template:
    spec:
      containers:
      - name: alembic
        image: postbot-backend:latest
        command: ["alembic", "upgrade", "head"]
        envFrom:
        - secretRef:
            name: postbot-secrets
      restartPolicy: Never
```

## Troubleshooting

### "Target database is not up to date"
```bash
# Check current version
alembic current

# Check what's pending
alembic history

# Apply pending migrations
alembic upgrade head
```

### "Can't locate revision identified by 'xxxx'"
```bash
# Stamp database to specific version (use carefully!)
alembic stamp head
```

### Migration Conflict
```bash
# If you have multiple migration branches
alembic merge -m "merge branches" head1 head2
```

## Integration with Existing Schema

The current `src/backend/db/migrations/schema.sql` file represents the existing schema. 

**To create initial migration from it:**
```bash
# 1. Ensure models.py matches schema.sql
# 2. Create initial migration
alembic revision --autogenerate -m "initial schema"

# 3. Review and edit if needed
# 4. Stamp database (don't run migration on existing DB)
alembic stamp head
```

For future changes, always use Alembic migrations instead of modifying schema.sql.

## See Also

- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [SQLAlchemy Documentation](https://docs.sqlalchemy.org/)
- [Database Setup Guide](../docs/DATABASE_SETUP.md)
